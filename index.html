
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>London Rent Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5.collide2d"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      
    <link rel="stylesheet" href="style.css">


    <script src="sketch.js"></script>
    <script src="sketch2.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  
  <!--style.css-->


  </head>
  <body>

    <!--
     <div class=" " id="map" style="height: 60vh; width: 60vw; margin: 0 auto;"></div>   绿地地图大小 -->
    <!--绿地地图缩放 const map = L.map('map').setView([51.505, -0.09], X );-->
  <!--
  <script>
    const map = L.map('map').setView([51.505, -0.09], 10); 
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    fetch('london_boroughs_final_with_named_green.geojson')
      .then(res => res.json())
      .then(data => {
        L.geoJSON(data, {
          style: feature => ({
            fillColor: getColor(feature.properties.percent_green_blue),
            weight: 1,
            color: 'white',
            fillOpacity: 0.7
          }),
          onEachFeature: (feature, layer) => {
            const name = feature.properties.name;
            const green = feature.properties.percent_green_blue;
            const rent = feature.properties.avg_rent;
            layer.bindPopup(`<b>${name}</b><br>绿化+蓝地：${green}%<br>租金：£${rent}`);
          }
        }).addTo(map);
      });

    function getColor(value) {
      return value > 60 ? '#1a9850' :
             value > 50 ? '#66bd63' :
             value > 40 ? '#a6d96a' :
             value > 30 ? '#d9ef8b' :
             value > 20 ? '#fee08b' :
             value > 10 ? '#fdae61' :
                          '#f46d43';
    }
  </script>
-->

<!-- part1 -->
  <div id="character">
    <img src="IMG_0407.GIF"  alt="character" >
    <img src="photo/hat.png" class="float-image img1 group1" />
    <img src="photo/plant.png" class="float-image img2 group1" />
    <img src="photo/money.png" class="float-image img3 group1" />

    <img src="photo/london.png" class="float-image img4 group2" />
    <img src="photo/pen.png" class="float-image img5 group2" />
    <img src="photo/pound.png" class="float-image img6 group2" />
  </div>

  


  <section class="section chat" id="bubble1" >
    <div class="bubble chat-block">她叫Sophie</div>
  </section>

  <section class="section chat" id="bubble2">
    <div class="bubble chat-block">她不是失败者</div>
  </section>

  <section class="section chat" id="bubble3">
    <div class="bubble chat-block">她做了她该做的一切</div>
  </section>

  <section class="section chat" id="bubble4">
    <div class="bubble chat-block">她在郊区长大 家里不富裕父母关系紧张</div>
  </section>

  <section class="section chat" id="bubble5">
    <div class="bubble chat-block">他考上了一所好大学 成绩稳定 努力申请奖学金</div>
  </section>

  <section class="section chat" id="bubble6">
    <div class="bubble chat-block">暑假打工也没有耽误论文</div>
  </section>

  <section class="section chat" id="bubble7">
    <div class="bubble chat-block">他毕业后被一家London的公司录用</div>
  </section>

  <section class="section chat" id="bubble8">
    <div class="bubble chat-block">一份她梦想中的UX设计师的工作</div>
  </section>

  <section class="section chat" id="bubble9">
    <div class="bubble chat-block">工资不高,但比老家已经好太多了</div>
  </section>

  <section class="section chat" id="bubble10">
    <div class="bubble chat-block">现在,问题只剩下一个,她要住哪里</div>
  </section>
    
  <script>
  gsap.registerPlugin(ScrollTrigger);

  gsap.to("#character", {
    opacity: 1,
    y: 0,
    duration: 0.5,
    ease: "power2.out",
    scrollTrigger: {
      trigger: "#bubble1",
      start: "top center",   // bubble1 进入中部开始
      toggleActions: "play none none reverse"
    }
  });

  // 角色淡出：bubble3 结束时
  gsap.to("#character", {
    opacity: 0,
    y: -50,
    duration: 0.8,
    ease: "power2.out",
    scrollTrigger: {
      trigger: "#bubble10",
      start: "bottom center",   // bubble3 底部到达中心时开始隐藏
      toggleActions: "play none none reverse"
    }
  });

  // 控制气泡逐句出现
  document.querySelectorAll(".bubble").forEach((el) => {
    gsap.to(el, {
      opacity: 1,
      y: 0,
      duration: 0.6,
      ease: "power2.out",
      scrollTrigger: {
        trigger: el,
        start: "top 80%",
        toggleActions: "play none none reverse"
      }
    });
  });
  
  // 显示 png1（bubble4）
  ScrollTrigger.create({
    trigger: "#bubble4",
    start: "top center",
    onEnter: () => document.querySelector(".img1").classList.add("show"),
    onLeaveBack: () => document.querySelector(".img1").classList.remove("show")
  });

  // 显示 png2（bubble5）
  ScrollTrigger.create({
    trigger: "#bubble5",
    start: "top center",
    onEnter: () => document.querySelector(".img2").classList.add("show"),
    onLeaveBack: () => document.querySelector(".img2").classList.remove("show")
  });

  // 显示 png3（bubble6）
  ScrollTrigger.create({
    trigger: "#bubble6",
    start: "top center",
    onEnter: () => document.querySelector(".img3").classList.add("show"),
    onLeaveBack: () => document.querySelector(".img3").classList.remove("show")
  });

  // bubble6 离开时全部隐藏
  ScrollTrigger.create({
    trigger: "#bubble6",
    start: "bottom 90%",
    onLeave: () => {
      document.querySelectorAll(".group1").forEach(el => el.classList.remove("show"));
    }
  });
  //--------------
  // 显示 png4（bubble7）
  ScrollTrigger.create({
    trigger: "#bubble7",
    start: "top center",
    onEnter: () => document.querySelector(".img4").classList.add("show"),
    onLeaveBack: () => document.querySelector(".img4").classList.remove("show")
  });

  // 显示 png5（bubble8）
  ScrollTrigger.create({
    trigger: "#bubble8",
    start: "top center",
    onEnter: () => document.querySelector(".img5").classList.add("show"),
    onLeaveBack: () => document.querySelector(".img5").classList.remove("show")
  });

  // 显示 png6（bubble9）
  ScrollTrigger.create({
    trigger: "#bubble9",
    start: "top center",
    onEnter: () => document.querySelector(".img6").classList.add("show"),
    onLeaveBack: () => document.querySelector(".img6").classList.remove("show")
  });

  // bubble9 离开时全部隐藏
  ScrollTrigger.create({
    trigger: "#bubble9",
    start: "bottom bottom",
    onLeave: () => {
      document.querySelectorAll(".group2").forEach(el => el.classList.remove("show"));
    }
  });
  </script>


<!-- part2 -->
<section class="section">
  <section class="chat" id="bubble2-1">
    <div class="bubble chat-block">她打开租房平台,看到价格密密麻麻分布在地图上</div>
  </section>
  
  <div id="map-container">
    <div id="map"></div>
  </div>
</section>

  <script>  
    // 地图map-container
    mapboxgl.accessToken = 'pk.eyJ1IjoicWFxb3ZvcXdxIiwiYSI6ImNtYmJqeXFwZzEyMG4ybHF1Z2xsNDFrM3IifQ.XWIUqmjrfxNA8rYM_x1yfg';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/dark-v11',
      center: [-0.1, 51.5],
      zoom: 9,
      pitch: 0,
      bearing: 0
    });
map.on('load', () => {
  
    map.scrollZoom.disable();

    
      map.addSource('rent', {
        type: 'geojson',
        data: 'london_rent_2025_merged.geojson'
      });

      map.addLayer({
        id: '3d-rent',
        type: 'fill-extrusion',
        source: 'rent',
        paint: {
          'fill-extrusion-color': [
            'interpolate',
            ['linear'],
            ['get', 'rent'],
            1000, '#99D0D9',
            3000, '#4D6782'
          ],
          'fill-extrusion-height': ['get', 'rent'],
          'fill-extrusion-opacity': 0.9
        }
      });
      });

      // 使用 GSAP ScrollTrigger 控制 pitch 变化
      gsap.registerPlugin(ScrollTrigger);
      gsap.to(map, {
        pitch: 60,
        zoom: 10,
        scrollTrigger: {
          trigger: "#map-container",
          start: "top center",
          end: "bottom center",
          scrub: true
        },
        onUpdate: () => {
          map.setPitch(map.pitch);
        }
      });
    
  </script>

  <!-- part3 -->
  <section class="section chat" id="bubble3-1">
    <div class="bubble chat-block">而她的收入是￡1850/月/最多用其中30%用于交房租</div>
  </section>

  <section id="city-scene">

    <div class="buildings top-layer">
      <img src="photo/building-left-top.png" class="building building-left-top building-left" />
      <img src="photo/building-right-top.png" class="building building-right-top building-right" />
    </div>

    <div id="girl-container">
      <img src="photo/girlback.png" id="girl" />
    </div>

    <div class="buildings bottom-layer">
      <img src="photo/building-bottom-left.png" class="building building-bottom-left building-left" />
      <img src="photo/building-bottom-right.png" class="building building-bottom-right building-right" />
    </div>
  </section>


  
  
  <script>
    // 初始偏移（x, y 不同方向）
    gsap.set(".building-left-top",     { x: -300, y: 0 });
    gsap.set(".building-right-top",    { x: 300, y: 0 });
    gsap.set(".building-bottom-left",  { x: -300, y: 300 });
    gsap.set(".building-bottom-right", { x: 300, y: 300 });

    // 当进入场景时 → 全部飞入中心（x:0, y:0）
    ScrollTrigger.create({
      trigger: "#city-scene",
      start: "top center",
      end: "bottom center",
      onEnter: () => {
        gsap.to(".building-left-top",     { x: 0, y: 0, opacity: 1, duration: 1 });
        gsap.to(".building-right-top",    { x: 0, y: 0, opacity: 1, duration: 1 });
        gsap.to(".building-bottom-left",  { x: 0, y: 0, opacity: 1, duration: 1 });
        gsap.to(".building-bottom-right", { x: 0, y: 0, opacity: 1, duration: 1 });
      },
      onLeaveBack: () => {
        gsap.to(".building", { opacity: 0 });
      }
    });

  </script>

  <!-- part4 -->


  <section class="chat" id="bubble4-1">
    <div class="bubble chat-block">代价是什么?<br>每天通勤2h+地铁+孤独感</div>
  </section>


  <div id="map-frame" style="position: relative; width: 600px; height: 600px; margin: 100px auto; transform-origin: center center;">
    <div id="map2" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;"></div>
    <div id="frame-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 8px solid white; z-index: 1; pointer-events: none;"></div>
    <canvas id="circle-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none;"></canvas>
    <img id="center-photo" src="photo/4-2.png" >
    <img id="center-bubble4-2" src="photo/bubble4-2.png" >

    <!-- <div id="center-bubble4-2" class="bubble ">这只是我的问题吗?</div> -->

</div>

  <section id="bubble4-2">
    <div class="chat-block"></div>
  </section>


<script>
  // 设置你的 Mapbox token
  mapboxgl.accessToken = 'pk.eyJ1IjoicWFxb3ZvcXdxIiwiYSI6ImNtYmJqeXFwZzEyMG4ybHF1Z2xsNDFrM3IifQ.XWIUqmjrfxNA8rYM_x1yfg';

  const map2 = new mapboxgl.Map({
    container: 'map2',
    style: 'mapbox://styles/mapbox/light-v10',
    center: [-0.1, 51.5],
    zoom: 9
  });
  // 禁用缩放和交互功能
  map2.scrollZoom.disable();      // 禁止滚轮缩放
  map2.doubleClickZoom.disable(); // 禁止双击缩放
  map2.boxZoom.disable();         // 禁止框选缩放
  map2.dragRotate.disable();      // 禁止旋转
  map2.touchZoomRotate.disable(); // 禁止触控缩放
  map2.dragPan.disable();         // 禁止拖拽移动（可选）


  // 等待地图加载完成
  map2.on('load', () => {
    // 加载 rent geojson
    fetch('london_rent_2025_one_bed.json')
      .then(res => res.json())
      .then(rentData => {
        fetch('london_rent_2025_merged.geojson')
          .then(res => res.json())
          .then(geojson => {
            // 合并租金数据
            geojson.features.forEach(feature => {
              const name = feature.properties.name;
              feature.properties.rent = rentData[name] || 0;
            });

            map2.addSource('rent', {
              type: 'geojson',
              data: geojson
            });

            map2.addLayer({
              id: 'rent-fill',
              type: 'fill',
              source: 'rent',
              paint: {
                'fill-color': [
                  'interpolate',
                  ['linear'],
                  ['get', 'rent'],
                  1000, '#f1eef6',
                  1500, '#d4b9da',
                  2000, '#c994c7',
                  2500, '#df65b0',
                  3000, '#e7298a',
                  3500, '#ce1256'
                ],
                'fill-opacity': 0.7
              }
            });

            map2.addLayer({
              id: 'rent-outline',
              type: 'line',
              source: 'rent',
              paint: {
                'line-color': '#ffffff',
                'line-width': 1
              }
            });
          });
      });
  });
</script>

<script>
  const canvas = document.getElementById('circle-canvas');
  const ctx = canvas.getContext('2d');

  function resizeCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
  }

  resizeCanvas();
  window.addEventListener('resize', () => {
    resizeCanvas();
    drawCircles(); // 重绘
  });

  const circles = [];
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  const colors = ['#ffffb2', '#fecc5c', '#fd8d3c', '#f03b20', '#bd0026', '#800026'];

  const maxRadius = Math.min(canvas.width, canvas.height) * 0.4; // 控制圆心区域半径

  for (let i = 0; i < 80; i++) {
    // 随机角度与半径，保证均匀分布在中心区域
    const angle = Math.random() * Math.PI * 2;
    const radiusFromCenter = Math.random() * maxRadius;

    const x = centerX + radiusFromCenter * Math.cos(angle);
    const y = centerY + radiusFromCenter * Math.sin(angle);

    const distRatio = radiusFromCenter / maxRadius; // 0 到 1

    const radius = 5 + distRatio * 20;
    const colorIndex = Math.min(Math.floor(distRatio * 6), 5);

    circles.push({ x, y, radius, color: colors[colorIndex] });
  }

  function drawCircles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (const circle of circles) {
      ctx.beginPath();
      ctx.arc(circle.x, circle.y, circle.radius, 0, Math.PI * 2);
      ctx.fillStyle = circle.color;
      ctx.fill();
    }
  }

  drawCircles();

    gsap.registerPlugin(ScrollTrigger);

  gsap.to("#map-frame", {
  scale: 20,
  ease: "none",
  scrollTrigger: {
    trigger: "#map-frame",
    start: "center center",
    endTrigger: "#bubble4-2",
    end: "top center",
    scrub: true,
    pin: "#map-frame",
    pinSpacing: true,
    onEnter: () => map2.resize(),
    onUpdate: () => map2.resize(),
    onLeave: () => {
      map2.resize();
      gsap.to("#map-frame", {
        opacity: 0,
        duration: 1,
        ease: "power2.out"
      });
    },
    onLeaveBack: () => {
      // 如果用户往回滚，重新显示 map-frame
      gsap.to("#map-frame", {
        opacity: 1,
        duration: 0.5
      });
    }
  }
});
</script>

<!-- part5 -->
  <section class="section chat" id="bubble5-1">
    <div class="bubble chat-block">于是她查询了更多发现那些租金最高的地方的,收入却常年没变</div>
  </section>
  <div id="chart5-2"></div>

  <script>
    const chartDom = document.getElementById('chart5-2');
    const myChart = echarts.init(chartDom);

    const option = {
      tooltip: {
        trigger: 'axis'
      },
      legend: {
        data: ['租金（£）', '月薪（£）']
      },
      xAxis: {
        type: 'category',
        data: ['2013','2014','2015','2016','2017','2018','2019']
      },
      yAxis: {
        type: 'value'
      },
      series: [
        {
          name: 'rent（£）',
          type: 'line',
          data: [1668, 1798, 1928, 2102, 2058, 1925, 2210],
          smooth: true,
          lineStyle: {
            width: 3
          }
        },
        {
          name: 'salary（£）',
          type: 'line',
          data: [3808, 3850, 3875, 3900, 3925, 3950, 3967],
          smooth: true,
          lineStyle: {
            width: 3
          }
        }
      ]
    };

    myChart.setOption(option);
  </script>

<!-- part6 -->

<!-- part7 -->
 <div class="section" style="background:#ffffff">
    <div class="title">伦敦人口正在增长</div>
    <canvas id="populationChart"></canvas>
</div>

<script>
    const populationCtx = document.getElementById('populationChart').getContext('2d');
    const populationChart = new Chart(populationCtx, {
        type: 'line',
        data: {
            labels: [2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022],
            datasets: [{
                label: '人口总数',
                data: [58892514, 59182170, 59456123, 59724394, 59988692, 60268457, 60609153, 61011788, 61507608, 62041708, 62759456, 63285145, 63710843, 64138721, 64619493, 65088058, 65607141, 65965992, 66288927, 66630707, 66744067, 66983488, 67603461],
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                fill: true,
                tension: 0.3,
                pointRadius: 3
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '2000-2022年英国人口增长趋势'
                }
            },
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
</script>

<!-- --------------------------------------------- -->
  <script> 
  //气泡渐隐效果
  gsap.utils.toArray(".chat-block").forEach((block) => {
    gsap.to(block, {
      opacity: 1,
      ease: "none",
      scrollTrigger: {
        trigger: block,
        start: "top 80%",      // 进入视口底部时开始出现
        end: "top 30%",        // 滚到视口上方 30% 时开始淡出
        scrub: true,           // 滚动时同步动画
        onLeave: () => gsap.to(block, { opacity: 0 }),
        onEnterBack: () => gsap.to(block, { opacity: 1 }),
        onLeaveBack: () => gsap.to(block, { opacity: 0 })
        }
    });
  });
  </script>


<!-- --------------------------------------------- -->
<!-- 淡入淡出动画 -->
<script>
  gsap.registerPlugin(ScrollTrigger);

  gsap.utils.toArray(".fade-text").forEach((elem) => {
    gsap.fromTo(
      elem,
      { opacity: 0, y: 30 },
      {
        opacity: 1,
        y: 0,
        duration: 1,
        ease: "power2.out",
        scrollTrigger: {
          trigger: elem,
          start: "top 80%",
          end: "top 20%",
          toggleActions: "play reverse play reverse",
        },
      }
    );
  });
</script>

<!-- step 激活高亮 -->
<script>
  const steps = document.querySelectorAll(".step");

  const stepObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        steps.forEach(step => step.classList.remove("is-active"));
        entry.target.classList.add("is-active");
      }
    });
  }, { threshold: 0.5 });

  steps.forEach(step => stepObserver.observe(step));
</script>



<div style="height: 50vh;"></div><!--半页空白-->
    
  </body>
</html>
